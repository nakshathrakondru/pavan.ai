<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Pavan</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Sans+Condensed:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="form-container">
        <h2>Register</h2>
        <button class="btn google-btn" id="google-login-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo">
            Register with Google
        </button>
        <div class="divider"><span>or</span></div>
        <form id="registration-form">
            <div class="input-group">
                <input type="text" id="name" placeholder="Name" required>
            </div>
            <div class="input-group">
                <input type="email" id="email" placeholder="Email" required>
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <div class="input-group">
                <input type="password" id="confirm_password" placeholder="Confirm Password" required>
            </div>
            <div class="input-group">
                <input type="text" id="contact_number" placeholder="Contact Number" required>
            </div>
            <button type="submit" class="btn submit-btn" id="register-btn">Register</button>
        </form>

        <div class="form-toggle">
            <span>Already have an account?</span>
            <a href="/login-page">Login</a>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyChZnOB48l2koPn5mPSqFqChoBv3ZhwKTw",
            authDomain: "pavanai-53e34.firebaseapp.com",
            databaseURL: "https://pavanai-53e34-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pavanai-53e34",
            storageBucket: "pavanai-53e34.firebasestorage.app",
            messagingSenderId: "169392243813",
            appId: "1:169392243813:web:6671bb6d6e9b2d150b328c",
            measurementId: "G-WQ28J3R0VF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Function to handle user registration
        function handleSubmit(event) {
            event.preventDefault(); // Prevent form submission

            // Get form values
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const contactNumber = document.getElementById('contact_number').value;

            // Email validation (only allow Gmail addresses)
            const emailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
            if (!emailRegex.test(email)) {
                alert("Please enter a valid Gmail address.");
                return; // Stop form submission
            }

            // Password match check
            if (password !== confirmPassword) {
                alert("Passwords do not match!");
                return;
            }

            // Password length check
            if (password.length < 6) {
                alert("Password must be at least 6 characters long.");
                return;
            }

            // Show loading state (optional)
            const registerBtn = document.getElementById("register-btn");
            registerBtn.disabled = true;
            registerBtn.innerText = "Registering...";

            // Register user with Firebase
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    // Save user data to Firebase Realtime Database
                    set(ref(db, 'users/' + user.uid), {
                        username: name,
                        email: email,
                        contactNumber: contactNumber
                    })
                    .then(() => {
                        window.location.href = '/login-page'; // Redirect after registration
                    })
                    .catch((error) => {
                        alert(`Error saving user data: ${error.message}`);
                    });
                })
                .catch((error) => {
                    alert(`Error during registration: ${error.message}`);
                })
                .finally(() => {
                    registerBtn.disabled = false;
                    registerBtn.innerText = "Register";
                });
        }

        // Google Sign-in button functionality
        document.getElementById('google-login-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;

                    // Save user data to Firebase Realtime Database
                    set(ref(db, 'users/' + user.uid), {
                        username: user.displayName,
                        email: user.email,
                        contactNumber: user.phoneNumber || "N/A"
                    })
                    .then(() => {
                        window.location.href = '/login-page'; // Redirect after registration
                    })
                    .catch((error) => {
                        alert(`Error saving user data: ${error.message}`);
                    });
                })
                .catch((error) => {
                    alert(`Error during Google sign-in: ${error.message}`);
                });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const registrationForm = document.getElementById('registration-form');
            if (registrationForm) {
                registrationForm.addEventListener('submit', handleSubmit);
            }
        });
    </script>
</body>
</html>